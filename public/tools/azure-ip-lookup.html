<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure IP Range Lookup</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }
        h1 { text-align: center; margin-bottom: 10px; color: #00d4ff; font-weight: 300; }
        .subtitle { text-align: center; color: #888; margin-bottom: 20px; font-size: 14px; }
        .container { max-width: 1100px; margin: 0 auto; }

        /* Upload section */
        .upload-section {
            background: #16213e;
            border: 2px dashed #333;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .upload-section:hover { border-color: #00d4ff; }
        .upload-section.loaded { border-style: solid; border-color: #2ecc71; }
        .upload-section input { display: none; }
        .upload-icon { font-size: 48px; margin-bottom: 10px; }
        .upload-text { color: #888; }
        .upload-link { color: #00d4ff; font-size: 13px; margin-top: 12px; }
        .upload-link a { color: #00d4ff; }
        .upload-link a:hover { text-decoration: underline; }
        .file-info { color: #2ecc71; margin-top: 10px; }

        /* Cloud badge */
        .cloud-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        .cloud-public { background: #2ecc71; color: #000; }
        .cloud-government { background: #e74c3c; color: #fff; }
        .cloud-china { background: #f39c12; color: #000; }
        .cloud-germany { background: #9b59b6; color: #fff; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            flex: 1;
            padding: 12px;
            background: #16213e;
            border: 1px solid #333;
            border-radius: 8px;
            color: #888;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.2s;
        }
        .tab:hover { border-color: #00d4ff; }
        .tab.active { background: #00d4ff; color: #1a1a2e; border-color: #00d4ff; }

        /* Search */
        .search-section { margin-bottom: 20px; }
        input[type="text"] {
            width: 100%;
            background: #16213e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 14px 16px;
            color: #eee;
            font-size: 16px;
            outline: none;
        }
        input[type="text"]:focus { border-color: #00d4ff; }
        input[type="text"]::placeholder { color: #555; }
        .search-hint { color: #888; font-size: 13px; margin-top: 8px; }

        /* Results */
        .results {
            background: #16213e;
            border: 1px solid #333;
            border-radius: 8px;
            max-height: 500px;
            overflow-y: auto;
        }
        .result-item {
            padding: 16px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            transition: background 0.2s;
        }
        .result-item:last-child { border-bottom: none; }
        .result-item:hover { background: #1d2a4d; }
        .result-item.expanded { background: #1d2a4d; }

        .service-name {
            font-weight: 600;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .service-region {
            color: #888;
            font-size: 13px;
            margin-top: 4px;
        }
        .ip-count {
            color: #00d4ff;
            font-size: 13px;
            margin-top: 4px;
        }

        /* Expanded view */
        .ip-list {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #333;
            display: none;
        }
        .result-item.expanded .ip-list { display: block; }
        .ip-item {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            padding: 4px 8px;
            background: #0f1629;
            border-radius: 4px;
            margin: 4px 0;
            display: inline-block;
            margin-right: 8px;
        }
        .ip-item.match { background: #00d4ff; color: #1a1a2e; }

        /* IP lookup result */
        .ip-match-info {
            background: rgba(0, 212, 255, 0.1);
            border-left: 3px solid #00d4ff;
            padding: 8px 12px;
            margin-top: 8px;
            font-size: 13px;
        }
        .ip-match-info code {
            background: #0f1629;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        /* Stats */
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .stat {
            background: #16213e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 12px 20px;
        }
        .stat-value { font-size: 24px; font-weight: 600; color: #00d4ff; }
        .stat-label { font-size: 12px; color: #888; text-transform: uppercase; }

        .no-results { padding: 40px; text-align: center; color: #888; }
        .hidden { display: none; }

        /* Non-public indicator */
        .non-public-icon {
            font-size: 16px;
            margin-right: 4px;
        }
    </style>
</head>
<body>
    <h1>Azure IP Range Lookup</h1>
    <p class="subtitle">Upload a Service Tags JSON file from Microsoft to search Azure IP ranges</p>

    <div class="container">
        <div class="upload-section" id="uploadSection" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" accept=".json">
            <div class="upload-icon">üìÅ</div>
            <div class="upload-text">Click to upload ServiceTags JSON file</div>
            <div class="upload-link">
                Get the latest file from <a href="https://www.microsoft.com/en-us/download/details.aspx?id=56519" target="_blank" onclick="event.stopPropagation()">Microsoft Download Center</a>
            </div>
            <div class="file-info" id="fileInfo"></div>
        </div>

        <div id="mainContent" class="hidden">
            <div class="stats" id="stats"></div>

            <div class="tabs">
                <div class="tab active" data-tab="service" onclick="switchTab('service')">
                    Service ‚Üí IP Ranges
                </div>
                <div class="tab" data-tab="ip" onclick="switchTab('ip')">
                    IP Address ‚Üí Services
                </div>
            </div>

            <div class="search-section">
                <input type="text" id="searchInput" placeholder="Search...">
                <div class="search-hint" id="searchHint">Search by service name (e.g., "Storage", "SQL", "AzureCloud")</div>
            </div>

            <div class="results" id="results">
                <div class="no-results">Start typing to search</div>
            </div>
        </div>
    </div>

    <script>
        let data = null;
        let currentTab = 'service';
        let searchTimeout = null;

        const fileInput = document.getElementById('fileInput');
        const uploadSection = document.getElementById('uploadSection');
        const mainContent = document.getElementById('mainContent');
        const searchInput = document.getElementById('searchInput');
        const searchHint = document.getElementById('searchHint');
        const results = document.getElementById('results');
        const stats = document.getElementById('stats');
        const fileInfo = document.getElementById('fileInfo');

        fileInput.addEventListener('change', handleFileUpload);
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(search, 150);
        });

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    data = JSON.parse(event.target.result);
                    if (!data.values || !Array.isArray(data.values)) {
                        throw new Error('Invalid format: missing values array');
                    }
                    uploadSection.classList.add('loaded');
                    fileInfo.innerHTML = `‚úì Loaded: ${file.name}<br>` +
                        `Cloud: <span class="cloud-badge ${getCloudClass(data.cloud)}">${getCloudIcon(data.cloud)} ${data.cloud || 'Unknown'}</span>`;
                    mainContent.classList.remove('hidden');
                    showStats();
                    search();
                } catch (err) {
                    alert('Error parsing JSON: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        function getCloudClass(cloud) {
            if (!cloud) return 'cloud-public';
            const c = cloud.toLowerCase();
            if (c.includes('government') || c.includes('usgov')) return 'cloud-government';
            if (c.includes('china')) return 'cloud-china';
            if (c.includes('germany')) return 'cloud-germany';
            return 'cloud-public';
        }

        function getCloudIcon(cloud) {
            if (!cloud) return '‚òÅÔ∏è';
            const c = cloud.toLowerCase();
            if (c.includes('government') || c.includes('usgov')) return 'üèõÔ∏è';
            if (c.includes('china')) return 'üêâ';
            if (c.includes('germany')) return 'ü¶Ö';
            return '‚òÅÔ∏è';
        }

        function showStats() {
            const totalServices = data.values.length;
            const totalIPs = data.values.reduce((sum, v) =>
                sum + (v.properties?.addressPrefixes?.length || 0), 0);
            const regions = new Set(data.values.map(v => v.properties?.region).filter(Boolean));

            stats.innerHTML = `
                <div class="stat">
                    <div class="stat-value">${totalServices}</div>
                    <div class="stat-label">Services</div>
                </div>
                <div class="stat">
                    <div class="stat-value">${totalIPs.toLocaleString()}</div>
                    <div class="stat-label">IP Ranges</div>
                </div>
                <div class="stat">
                    <div class="stat-value">${regions.size}</div>
                    <div class="stat-label">Regions</div>
                </div>
            `;
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');

            if (tab === 'service') {
                searchInput.placeholder = 'Search by service name...';
                searchHint.textContent = 'Search by service name (e.g., "Storage", "SQL", "AzureCloud")';
            } else {
                searchInput.placeholder = 'Enter IP address (e.g., 20.38.147.10)...';
                searchHint.textContent = 'Enter an IP address to find which Azure services it belongs to';
            }
            searchInput.value = '';
            results.innerHTML = '<div class="no-results">Start typing to search</div>';
        }

        function search() {
            const query = searchInput.value.trim();
            if (!query) {
                results.innerHTML = '<div class="no-results">Start typing to search</div>';
                return;
            }

            if (currentTab === 'service') {
                searchServices(query);
            } else {
                searchIP(query);
            }
        }

        function searchServices(query) {
            const q = query.toLowerCase();
            const matches = data.values.filter(v =>
                v.name.toLowerCase().includes(q) ||
                (v.properties?.systemService || '').toLowerCase().includes(q) ||
                (v.properties?.region || '').toLowerCase().includes(q)
            ).slice(0, 100);

            if (matches.length === 0) {
                results.innerHTML = '<div class="no-results">No services found</div>';
                return;
            }

            results.innerHTML = matches.map(v => {
                const prefixes = v.properties?.addressPrefixes || [];
                const region = v.properties?.region || 'Global';
                return `
                    <div class="result-item" onclick="this.classList.toggle('expanded')">
                        <div class="service-name">
                            ${v.name}
                        </div>
                        <div class="service-region">Region: ${region}</div>
                        <div class="ip-count">${prefixes.length} IP range${prefixes.length !== 1 ? 's' : ''}</div>
                        <div class="ip-list">
                            ${prefixes.slice(0, 50).map(ip => `<span class="ip-item">${escapeHtml(ip)}</span>`).join('')}
                            ${prefixes.length > 50 ? `<div style="margin-top:8px;color:#888;">...and ${prefixes.length - 50} more</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function searchIP(query) {
            // Validate IP format
            if (!isValidIP(query)) {
                results.innerHTML = '<div class="no-results">Enter a valid IPv4 address (e.g., 20.38.147.10)</div>';
                return;
            }

            const ipNum = ipToNumber(query);
            const matches = [];

            for (const service of data.values) {
                const prefixes = service.properties?.addressPrefixes || [];
                const matchingPrefixes = [];

                for (const prefix of prefixes) {
                    if (ipInCIDR(ipNum, prefix)) {
                        matchingPrefixes.push(prefix);
                    }
                }

                if (matchingPrefixes.length > 0) {
                    matches.push({
                        service,
                        matchingPrefixes
                    });
                }
            }

            if (matches.length === 0) {
                results.innerHTML = '<div class="no-results">No Azure services found for this IP address</div>';
                return;
            }

            results.innerHTML = matches.map(m => {
                const v = m.service;
                const region = v.properties?.region || 'Global';
                const allPrefixes = v.properties?.addressPrefixes || [];
                return `
                    <div class="result-item" onclick="this.classList.toggle('expanded')">
                        <div class="service-name">
                            ${escapeHtml(v.name)}
                        </div>
                        <div class="service-region">Region: ${region}</div>
                        <div class="ip-match-info">
                            <strong>${query}</strong> matches:
                            ${m.matchingPrefixes.map(p => `<code>${escapeHtml(p)}</code>`).join(', ')}
                        </div>
                        <div class="ip-list">
                            ${allPrefixes.slice(0, 50).map(ip =>
                                `<span class="ip-item${m.matchingPrefixes.includes(ip) ? ' match' : ''}">${escapeHtml(ip)}</span>`
                            ).join('')}
                            ${allPrefixes.length > 50 ? `<div style="margin-top:8px;color:#888;">...and ${allPrefixes.length - 50} more</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // IP utility functions
        function isValidIP(ip) {
            const parts = ip.split('.');
            if (parts.length !== 4) return false;
            return parts.every(p => {
                const num = parseInt(p, 10);
                return !isNaN(num) && num >= 0 && num <= 255 && p === num.toString();
            });
        }

        function ipToNumber(ip) {
            const parts = ip.split('.').map(Number);
            return ((parts[0] << 24) | (parts[1] << 16) | (parts[2] << 8) | parts[3]) >>> 0;
        }

        function ipInCIDR(ipNum, cidr) {
            const [rangeIP, bits] = cidr.split('/');
            if (!isValidIP(rangeIP)) return false;

            const maskBits = parseInt(bits, 10);
            if (isNaN(maskBits) || maskBits < 0 || maskBits > 32) return false;

            const rangeNum = ipToNumber(rangeIP);
            const mask = maskBits === 0 ? 0 : (~0 << (32 - maskBits)) >>> 0;

            return (ipNum & mask) === (rangeNum & mask);
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
    </script>
</body>
</html>
