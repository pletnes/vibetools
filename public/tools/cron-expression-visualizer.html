<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cron Expression Visualizer</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }
        h1 { text-align: center; margin-bottom: 20px; color: #00d4ff; font-weight: 300; }
        .container { max-width: 900px; margin: 0 auto; }

        /* Input section */
        .input-section {
            background: #16213e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .input-row input {
            flex: 1;
            background: #0f1629;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 14px 16px;
            color: #eee;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 18px;
            outline: none;
        }
        .input-row input:focus { border-color: #00d4ff; }
        .input-row input::placeholder { color: #555; }

        /* Preset buttons */
        .presets {
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .presets button {
            background: #333;
            color: #eee;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            transition: background 0.2s;
        }
        .presets button:hover { background: #444; }
        .presets button:active { transform: scale(0.98); }

        /* Error display */
        .error { color: #ff6b6b; font-size: 13px; margin-top: 10px; min-height: 20px; }

        /* Field breakdown */
        .field-breakdown {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .field-card {
            background: #16213e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 12px 16px;
            text-align: center;
            min-width: 120px;
            flex: 1;
        }
        .field-card.active { border-color: #00d4ff; }
        .field-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            margin-bottom: 6px;
        }
        .field-value {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 20px;
            color: #00d4ff;
            margin-bottom: 4px;
        }
        .field-meaning {
            font-size: 12px;
            color: #ccc;
        }

        /* Description panel */
        .panel {
            background: #16213e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .panel-header h2 {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
        }
        .description-text {
            font-size: 18px;
            line-height: 1.6;
            color: #eee;
        }
        .description-text .highlight {
            color: #00d4ff;
            font-weight: 600;
        }

        /* Next runs */
        .next-runs-list {
            list-style: none;
        }
        .next-runs-list li {
            padding: 10px 14px;
            border-bottom: 1px solid #222;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .next-runs-list li:last-child { border-bottom: none; }
        .run-date { color: #eee; }
        .run-relative { color: #888; font-size: 12px; }

        /* Visual grid */
        .grid-section {
            margin-bottom: 20px;
        }
        .grid-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .hour-grid, .minute-grid, .month-grid, .dom-grid, .dow-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
        }
        .grid-cell {
            width: 32px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            border-radius: 4px;
            background: #0f1629;
            color: #555;
            border: 1px solid #222;
        }
        .grid-cell.active {
            background: #00d4ff22;
            color: #00d4ff;
            border-color: #00d4ff44;
        }

        /* Buttons */
        button {
            background: #00d4ff;
            color: #1a1a2e;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.2s;
        }
        button:hover { background: #00a8cc; }
        button:active { transform: scale(0.98); }

        /* Two column layout for grids */
        .grids-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 700px) {
            .grids-container { grid-template-columns: 1fr; }
            .field-breakdown { gap: 4px; }
            .field-card { min-width: 60px; padding: 8px; }
            .field-value { font-size: 16px; }
        }

        /* Syntax reference */
        .syntax-ref {
            margin-top: 20px;
            font-size: 13px;
            color: #888;
        }
        .syntax-ref table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
        }
        .syntax-ref th, .syntax-ref td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #222;
        }
        .syntax-ref th {
            color: #888;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .syntax-ref td {
            color: #ccc;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
        }
        .syntax-ref td:last-child {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Cron Expression Visualizer</h1>

        <div class="input-section">
            <div class="input-row">
                <input type="text" id="cronInput" placeholder="e.g. */5 * * * * or @hourly" value="55 0-2,4-23 * * *" spellcheck="false">
                <button onclick="copyExpression()">Copy</button>
            </div>
            <div class="presets">
                <button onclick="setPreset('@yearly')">@yearly</button>
                <button onclick="setPreset('@monthly')">@monthly</button>
                <button onclick="setPreset('@weekly')">@weekly</button>
                <button onclick="setPreset('@daily')">@daily</button>
                <button onclick="setPreset('@hourly')">@hourly</button>
                <button onclick="setPreset('*/5 * * * *')">Every 5 min</button>
                <button onclick="setPreset('0 9-17 * * 1-5')">Work hours</button>
                <button onclick="setPreset('55 0-2,4-23 * * *')">55 0-2,4-23 * * *</button>
            </div>
            <div class="error" id="error"></div>
        </div>

        <div class="field-breakdown" id="fieldBreakdown"></div>

        <div class="panel" id="descriptionPanel" style="display:none;">
            <div class="panel-header">
                <h2>Description</h2>
            </div>
            <div class="description-text" id="description"></div>
        </div>

        <div class="panel" id="gridPanel" style="display:none;">
            <div class="panel-header">
                <h2>Schedule Grid</h2>
            </div>
            <div class="grids-container">
                <div class="grid-section">
                    <div class="grid-label">Minutes (0-59)</div>
                    <div class="minute-grid" id="minuteGrid"></div>
                </div>
                <div class="grid-section">
                    <div class="grid-label">Hours (0-23)</div>
                    <div class="hour-grid" id="hourGrid"></div>
                </div>
                <div class="grid-section">
                    <div class="grid-label">Day of Month (1-31)</div>
                    <div class="dom-grid" id="domGrid"></div>
                </div>
                <div class="grid-section">
                    <div class="grid-label">Month (1-12)</div>
                    <div class="month-grid" id="monthGrid"></div>
                </div>
            </div>
            <div class="grid-section" style="margin-top: 16px;">
                <div class="grid-label">Day of Week</div>
                <div class="dow-grid" id="dowGrid"></div>
            </div>
        </div>

        <div class="panel" id="nextRunsPanel" style="display:none;">
            <div class="panel-header">
                <h2>Next 10 Runs</h2>
            </div>
            <ul class="next-runs-list" id="nextRunsList"></ul>
        </div>

        <div class="panel">
            <div class="panel-header">
                <h2>Syntax Reference</h2>
            </div>
            <div class="syntax-ref">
                <pre style="color:#888; font-size:12px; margin-bottom:12px; line-height:1.5;">
# ┌───────────── minute (0-59)
# │ ┌───────────── hour (0-23)
# │ │ ┌───────────── day of month (1-31)
# │ │ │ ┌───────────── month (1-12)
# │ │ │ │ ┌───────────── day of week (0-6, Sun=0)
# │ │ │ │ │
# * * * * *</pre>
                <table>
                    <tr><th>Symbol</th><th>Meaning</th><th>Example</th></tr>
                    <tr><td>*</td><td>Any value</td><td>* in hour = every hour</td></tr>
                    <tr><td>,</td><td>List</td><td>1,3,5 in day = 1st, 3rd, 5th</td></tr>
                    <tr><td>-</td><td>Range</td><td>1-5 in dow = Mon through Fri</td></tr>
                    <tr><td>/</td><td>Step</td><td>*/15 in min = every 15 minutes</td></tr>
                </table>
                <table style="margin-top: 16px;">
                    <tr><th>Macro</th><th>Equivalent</th><th>Meaning</th></tr>
                    <tr><td>@yearly</td><td>0 0 1 1 *</td><td>Once a year (Jan 1)</td></tr>
                    <tr><td>@monthly</td><td>0 0 1 * *</td><td>Once a month (1st)</td></tr>
                    <tr><td>@weekly</td><td>0 0 * * 0</td><td>Once a week (Sunday)</td></tr>
                    <tr><td>@daily</td><td>0 0 * * *</td><td>Once a day (midnight)</td></tr>
                    <tr><td>@hourly</td><td>0 * * * *</td><td>Once an hour (:00)</td></tr>
                </table>
            </div>
        </div>
    </div>

    <script>
        const MACROS = {
            '@yearly':   '0 0 1 1 *',
            '@annually': '0 0 1 1 *',
            '@monthly':  '0 0 1 * *',
            '@weekly':   '0 0 * * 0',
            '@daily':    '0 0 * * *',
            '@midnight': '0 0 * * *',
            '@hourly':   '0 * * * *'
        };

        const FIELD_NAMES = ['Minute', 'Hour', 'Day of Month', 'Month', 'Day of Week'];
        const FIELD_RANGES = [
            { min: 0, max: 59 },
            { min: 0, max: 23 },
            { min: 1, max: 31 },
            { min: 1, max: 12 },
            { min: 0, max: 6 }
        ];

        const MONTH_NAMES = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const DOW_NAMES = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const DOW_MAP = { sun: 0, mon: 1, tue: 2, wed: 3, thu: 4, fri: 5, sat: 6 };

        const cronInput = document.getElementById('cronInput');
        const errorEl = document.getElementById('error');

        let timeout;
        cronInput.addEventListener('input', () => {
            clearTimeout(timeout);
            timeout = setTimeout(parse, 150);
        });

        function setPreset(expr) {
            cronInput.value = expr;
            parse();
        }

        function copyExpression() {
            navigator.clipboard.writeText(cronInput.value).then(() => {
                const btn = event.target;
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = 'Copy', 1500);
            });
        }

        function parseField(field, index) {
            const range = FIELD_RANGES[index];
            const values = new Set();

            // Handle day-of-week names
            if (index === 4) {
                field = field.toLowerCase().replace(/sun|mon|tue|wed|thu|fri|sat/g, m => DOW_MAP[m]);
            }

            const parts = field.split(',');
            for (const part of parts) {
                const stepMatch = part.match(/^(.+)\/(\d+)$/);
                let base = stepMatch ? stepMatch[1] : part;
                const step = stepMatch ? parseInt(stepMatch[2]) : 1;

                if (step < 1) throw new Error(`Invalid step value in field "${FIELD_NAMES[index]}"`);

                let start, end;
                if (base === '*') {
                    start = range.min;
                    end = range.max;
                } else if (base.includes('-')) {
                    const [a, b] = base.split('-').map(Number);
                    if (isNaN(a) || isNaN(b)) throw new Error(`Invalid range in "${FIELD_NAMES[index]}"`);
                    if (a < range.min || a > range.max || b < range.min || b > range.max) {
                        throw new Error(`Value out of range for "${FIELD_NAMES[index]}" (${range.min}-${range.max})`);
                    }
                    start = a;
                    end = b;
                } else {
                    const n = parseInt(base);
                    if (isNaN(n)) throw new Error(`Invalid value "${base}" in "${FIELD_NAMES[index]}"`);
                    if (n < range.min || n > range.max) {
                        throw new Error(`Value ${n} out of range for "${FIELD_NAMES[index]}" (${range.min}-${range.max})`);
                    }
                    start = n;
                    end = n;
                }

                for (let i = start; i <= end; i += step) {
                    values.add(i);
                }
            }

            return values;
        }

        function describeField(field, index) {
            const range = FIELD_RANGES[index];

            // Handle day-of-week names
            let normalizedField = field;
            if (index === 4) {
                normalizedField = field.toLowerCase().replace(/sun|mon|tue|wed|thu|fri|sat/g, m => DOW_MAP[m]);
            }

            if (field === '*') return 'every ' + FIELD_NAMES[index].toLowerCase();

            const parts = field.split(',');
            const descriptions = [];

            for (const part of parts) {
                const stepMatch = part.match(/^(.+)\/(\d+)$/);
                let base = stepMatch ? stepMatch[1] : part;
                const step = stepMatch ? parseInt(stepMatch[2]) : null;

                if (index === 4) {
                    base = base.toLowerCase().replace(/sun|mon|tue|wed|thu|fri|sat/g, m => DOW_MAP[m]);
                }

                if (base === '*' && step) {
                    if (index === 0) descriptions.push(`every ${step} minutes`);
                    else if (index === 1) descriptions.push(`every ${step} hours`);
                    else descriptions.push(`every ${step}`);
                } else if (base.includes('-')) {
                    const [a, b] = base.split('-').map(Number);
                    let rangeStr;
                    if (index === 4) rangeStr = `${DOW_NAMES[a]} through ${DOW_NAMES[b]}`;
                    else if (index === 3) rangeStr = `${MONTH_NAMES[a]} through ${MONTH_NAMES[b]}`;
                    else rangeStr = `${a} through ${b}`;

                    if (step) rangeStr += ` (every ${step})`;
                    descriptions.push(rangeStr);
                } else {
                    const n = parseInt(base);
                    if (index === 4) descriptions.push(DOW_NAMES[n]);
                    else if (index === 3) descriptions.push(MONTH_NAMES[n]);
                    else descriptions.push(String(n));
                }
            }

            return descriptions.join(', ');
        }

        function buildHumanDescription(fields, parsed) {
            const [minutes, hours, dom, months, dow] = parsed;
            const [minField, hourField, domField, monthField, dowField] = fields;
            const parts = [];

            // Time description
            if (minField === '*' && hourField === '*') {
                parts.push('At every minute');
            } else if (minField.includes('/')) {
                const step = minField.split('/')[1];
                if (hourField === '*') {
                    parts.push(`Every <span class="highlight">${step} minutes</span>`);
                } else {
                    parts.push(`Every <span class="highlight">${step} minutes</span> past ${describeHours(hourField, hours)}`);
                }
            } else if (hourField === '*') {
                parts.push(`At minute <span class="highlight">${describeField(minField, 0)}</span> of every hour`);
            } else {
                const minDesc = minutes.size === 1 ? formatMinute([...minutes][0]) : describeField(minField, 0);
                parts.push(`At <span class="highlight">${minDesc}</span> past ${describeHours(hourField, hours)}`);
            }

            // Day of month
            if (domField !== '*') {
                parts.push(`on day <span class="highlight">${describeField(domField, 2)}</span> of the month`);
            }

            // Month
            if (monthField !== '*') {
                parts.push(`in <span class="highlight">${describeField(monthField, 3)}</span>`);
            }

            // Day of week
            if (dowField !== '*') {
                parts.push(`on <span class="highlight">${describeField(dowField, 4)}</span>`);
            }

            return parts.join(', ') + '.';
        }

        function describeHours(field, hours) {
            if (hours.size === 24) return 'every hour';
            const sorted = [...hours].sort((a, b) => a - b);
            if (sorted.length <= 3) {
                return 'hour ' + sorted.map(h => `<span class="highlight">${h}</span>`).join(', ');
            }
            return `hours <span class="highlight">${describeField(field, 1)}</span>`;
        }

        function formatMinute(m) {
            return 'minute ' + m;
        }

        function getNextRuns(parsed, count) {
            const [minutes, hours, dom, months, dow] = parsed;
            const runs = [];
            const now = new Date();
            let candidate = new Date(now);
            candidate.setSeconds(0);
            candidate.setMilliseconds(0);
            candidate.setMinutes(candidate.getMinutes() + 1);

            const maxIterations = 525960; // ~1 year of minutes
            let iterations = 0;

            while (runs.length < count && iterations < maxIterations) {
                iterations++;
                const m = candidate.getMinutes();
                const h = candidate.getHours();
                const d = candidate.getDate();
                const mo = candidate.getMonth() + 1;
                const dw = candidate.getDay();

                if (months.has(mo) && dom.has(d) && dow.has(dw) && hours.has(h) && minutes.has(m)) {
                    runs.push(new Date(candidate));
                }

                candidate.setMinutes(candidate.getMinutes() + 1);
            }

            return runs;
        }

        function formatRelative(date) {
            const now = new Date();
            const diff = date - now;
            const mins = Math.floor(diff / 60000);
            const hours = Math.floor(mins / 60);
            const days = Math.floor(hours / 24);

            if (mins < 60) return `in ${mins}m`;
            if (hours < 24) return `in ${hours}h ${mins % 60}m`;
            if (days < 7) return `in ${days}d ${hours % 24}h`;
            return `in ${days}d`;
        }

        function buildFieldBreakdown(fields) {
            const container = document.getElementById('fieldBreakdown');
            container.innerHTML = '';

            fields.forEach((field, i) => {
                const card = document.createElement('div');
                card.className = 'field-card';
                card.innerHTML = `
                    <div class="field-label">${FIELD_NAMES[i]}</div>
                    <div class="field-value">${escapeHtml(field)}</div>
                    <div class="field-meaning">${escapeHtml(describeField(field, i))}</div>
                `;
                container.appendChild(card);
            });
        }

        function buildGrid(containerId, range, activeValues, labels) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            for (let i = range.min; i <= range.max; i++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell' + (activeValues.has(i) ? ' active' : '');
                cell.textContent = labels ? labels[i] : i;
                container.appendChild(cell);
            }
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function parse() {
            errorEl.textContent = '';
            let expr = cronInput.value.trim();

            if (!expr) {
                document.getElementById('fieldBreakdown').innerHTML = '';
                document.getElementById('descriptionPanel').style.display = 'none';
                document.getElementById('gridPanel').style.display = 'none';
                document.getElementById('nextRunsPanel').style.display = 'none';
                return;
            }

            // Expand macros
            const lower = expr.toLowerCase();
            if (MACROS[lower]) {
                expr = MACROS[lower];
            }

            const fields = expr.split(/\s+/);
            if (fields.length !== 5) {
                errorEl.textContent = `Expected 5 fields, got ${fields.length}. Format: minute hour day-of-month month day-of-week`;
                document.getElementById('fieldBreakdown').innerHTML = '';
                document.getElementById('descriptionPanel').style.display = 'none';
                document.getElementById('gridPanel').style.display = 'none';
                document.getElementById('nextRunsPanel').style.display = 'none';
                return;
            }

            try {
                const parsed = fields.map((f, i) => parseField(f, i));
                const [minutes, hours, dom, months, dow] = parsed;

                // Field breakdown
                buildFieldBreakdown(fields);

                // Description
                const desc = buildHumanDescription(fields, parsed);
                document.getElementById('description').innerHTML = desc;
                document.getElementById('descriptionPanel').style.display = 'block';

                // Grids
                buildGrid('minuteGrid', { min: 0, max: 59 }, minutes);
                buildGrid('hourGrid', { min: 0, max: 23 }, hours);
                buildGrid('domGrid', { min: 1, max: 31 }, dom);
                buildGrid('monthGrid', { min: 1, max: 12 }, months, MONTH_NAMES);
                buildGrid('dowGrid', { min: 0, max: 6 }, dow, DOW_NAMES);
                document.getElementById('gridPanel').style.display = 'block';

                // Next runs
                const runs = getNextRuns(parsed, 10);
                const list = document.getElementById('nextRunsList');
                list.innerHTML = '';
                if (runs.length === 0) {
                    list.innerHTML = '<li style="color:#888;">No upcoming runs found within the next year.</li>';
                } else {
                    runs.forEach(run => {
                        const li = document.createElement('li');
                        const dateStr = run.toLocaleString(undefined, {
                            weekday: 'short',
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false
                        });
                        li.innerHTML = `<span class="run-date">${escapeHtml(dateStr)}</span><span class="run-relative">${escapeHtml(formatRelative(run))}</span>`;
                        list.appendChild(li);
                    });
                }
                document.getElementById('nextRunsPanel').style.display = 'block';

            } catch (e) {
                errorEl.textContent = e.message;
                document.getElementById('descriptionPanel').style.display = 'none';
                document.getElementById('gridPanel').style.display = 'none';
                document.getElementById('nextRunsPanel').style.display = 'none';
            }
        }

        // Parse on load
        parse();
    </script>
</body>
</html>
